name: Build pimusic docker image

on:
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Prepare Dockerfile from template
      shell: bash
      run : |
        ./prepare_dockerfile.sh -a amd64 -c ./config.yaml -d ./Dockerfile -v

    - name: Docker build
      shell: bash
      env: 
        DH_USERNAME: ${{ secrets.DOCKERHUB_LOGIN }}
      run: |
        docker build -f ./Dockerfile -t ${DH_USERNAME}/pimusic_amd64:${GITHUB_REF##*/} .
  build-arm32:
    runs-on: [self-hosted, ARM]
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Prepare Dockerfile from template
      shell: bash
      run : |
        ./prepare_dockerfile.sh -a arm32 -c ./config.yaml -d ./Dockerfile -v

    - name: Docker build
      shell: bash
      env: 
        DH_USERNAME: ${{ secrets.DOCKERHUB_LOGIN }}
      run: |
        docker build -f ./Dockerfile -t ${DH_USERNAME}/pimusic:${GITHUB_REF##*/} .
